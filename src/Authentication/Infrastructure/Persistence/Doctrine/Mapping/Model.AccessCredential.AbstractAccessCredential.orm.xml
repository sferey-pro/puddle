<?xml version="1.0" encoding="UTF-8"?>
<doctrine-mapping xmlns="http://doctrine-project.org/schemas/orm/doctrine-mapping"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://doctrine-project.org/schemas/orm/doctrine-mapping
                          https://www.doctrine-project.org/schemas/orm/doctrine-mapping.xsd">

    <!--
    ==================== ACCESS CREDENTIAL (SINGLE TABLE INHERITANCE) ====================

        Table unique pour tous les types de credentials avec discriminator.

        Architecture :
            - AbstractAccessCredential : Class abstraite commune
            - MagicLinkCredential : Pour authentification par email
            - OTPCredential : Pour authentification par SMS
            - Future : PasswordCredential, OAuthCredential

        Stratégie SINGLE_TABLE pour :
            - Performance des requêtes cross-type
            - Simplicité de gestion
            - Facilité d'ajout de nouveaux types
    -->

    <entity name="Authentication\Domain\Model\AccessCredential\AbstractAccessCredential"
            table="access_credentials"
            inheritance-type="SINGLE_TABLE"
            abstract="true">

        <!-- ==================== DISCRIMINATOR ==================== -->

        <discriminator-column name="type" type="string" length="20" />

        <discriminator-map>
            <discriminator-mapping value="magic_link" class="Authentication\Domain\Model\AccessCredential\MagicLinkCredential" />
            <discriminator-mapping value="otp" class="Authentication\Domain\Model\AccessCredential\OTPCredential" />
            <!-- Future mappings -->
            <!-- <discriminator-mapping value="password" class="Authentication\Domain\Model\AccessCredential\PasswordCredential" /> -->
            <!-- <discriminator-mapping value="oauth" class="Authentication\Domain\Model\AccessCredential\OAuthCredential" /> -->
        </discriminator-map>

        <!-- ==================== PROPRIÉTÉS COMMUNES ==================== -->
        <id name="id" type="credential_id" column="id" length="36" />        <!-- User associé (nullable pour les nouvelles inscriptions) -->
        <field name="userId" type="user_id" column="user_id" nullable="true">
            <options>
                <option name="comment">Associated user ID (null for new registrations)</option>
            </options>
        </field>

        <!-- Identifiant (email ou phone) -->
        <field name="identifier" type="string" column="identifier" length="255" nullable="false">
            <options>
                <option name="comment">Email or phone number</option>
            </options>
        </field>

        <!-- Timestamps -->
        <field name="createdAt" type="datetime_immutable" column="created_at" nullable="false">
            <options>
                <option name="default">CURRENT_TIMESTAMP</option>
            </options>
        </field>

        <field name="expiresAt" type="datetime_immutable" column="expires_at" nullable="false">
            <options>
                <option name="comment">Expiration time for the credential</option>
            </options>
        </field>

        <field name="usedAt" type="datetime_immutable" column="used_at" nullable="true">
            <options>
                <option name="comment">When the credential was used (null if not used)</option>
            </options>
        </field>

        <!-- Metadata JSON -->
        <field name="metadata" type="json" column="metadata" nullable="true">
            <options>
                <option name="comment">Additional data: IP, user agent, etc.</option>
                <option name="default">{}</option>
            </options>
        </field>

        <!-- ==================== LIFECYCLE CALLBACKS ==================== -->

        <!--
            <lifecycle-callbacks>
                <lifecycle-callback type="prePersist" method="onPrePersist" />
            </lifecycle-callbacks>
        -->

    </entity>

</doctrine-mapping>
