<!-- src/Identity/Infrastructure/Persistence/Doctrine/Mapping/Identity.Model.UserIdentity.orm.xml -->
<doctrine-mapping xmlns="http://doctrine-project.org/schemas/orm/doctrine-mapping"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://doctrine-project.org/schemas/orm/doctrine-mapping
                          https://www.doctrine-project.org/schemas/orm/doctrine-mapping.xsd">

    <entity name="Identity\Domain\UserIdentity" table="identity_user_identities">

        <id name="userId" type="account_id" column="account_id"/>

        <!--
            C'est la relation clé.
            - target-entity: L'entité interne de l'agrégat.
            - mapped-by: Le nom de la propriété dans AttachedIdentifier qui pointe vers UserIdentity.
            - cascade: Les opérations (persist, remove) sont propagées aux enfants. Si on sauve UserIdentity, ses AttachedIdentifiers sont sauvés aussi.
            - orphanRemoval: Si on retire un AttachedIdentifier de la collection dans le code, Doctrine le supprimera de la BDD.
            Ceci garantit que le cycle de vie de AttachedIdentifier est entièrement contrôlé par UserIdentity, comme l'exige le pattern Aggregate.
        -->
        <one-to-many field="identifiers"
                     target-entity="Identity\Domain\AttachedIdentifier"
                     mapped-by="userIdentity"
                     cascade="{"persist", "remove"}"
                     orphan-removal="true"
                     fetch="EAGER"/>

    </entity>

</doctrine-mapping>
